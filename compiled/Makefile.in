THIS_DIR := $(PARENT_DIR)/compiled
VPATH = .:$(THIS_DIR)
CXX := g++
CC  := gcc
MYSQL_CONFIG := @MYSQL_CONFIG@
ifneq ($(MYSQL_CONFIG),UNKNOWN)
  MYSQL_CFLAGS  := $(shell $(MYSQL_CONFIG) --cflags) -DHAVE_MYSQL
  MYSQL_LDFLAGS := $(shell $(MYSQL_CONFIG) --libs)  
endif

LIB_OPTIONS       := -fPIC -shared

CF_INIT     := -I. -fPIC 
CXXFLAGS    := -g -O0 -std=c++11 -Ibuild_h $(MYSQL_CFLAGS)
CFLAGS      := -g -O0 
EXEC  	    := $(DESTDIR)$(LIBEXEC)/xalt_run_submission
SRC   	    := xalt_run_submission.C ConfigParser.C Json.C Options.C Process.C base64.C              \
               buildEnvT.C buildRmapT.C buildUserT.C capture.C run_direct2db.C extractXALTRecord.C   \
               parseJsonStr.C parseLDD.C translate.C transmit.C xalt_mysql_utils.C xalt_utils.C      \
               zstring.C 
C_SRC 	    := xalt_quotestring.c xalt_fgets_alloc.c jsmn.c

OBJS  	    := $(patsubst %.C, %.o, $(SRC)) $(patsubst %.c, %.o, $(C_SRC))

F2DB_SRC    := f2db_Options.C 


all: ECHO $(EXEC) build_init $(DESTDIR)$(LIBEXEC)/xalt_syshost           \
                             $(DESTDIR)$(LIBEXEC)/xalt_generate_assembly \
                             $(DESTDIR)$(LIBEXEC)/xalt_strip_linklib     \
                             $(DESTDIR)$(LIBEXEC)/xalt_extract_linker    \
                             $(DESTDIR)$(LIBEXEC)/xalt_generate_linkdata \
                             $(DESTDIR)$(LIBEXEC)/xalt_file_to_db


ECHO:
	@echo XALT_EXECUTABLE_TRACKING: $(XALT_EXECUTABLE_TRACKING)

$(EXEC) : $(OBJS)
	$(LINK.C) -o $@ $^ -lz $(MYSQL_LDFLAGS)

$(DESTDIR)$(LIBEXEC)/xalt_syshost: xalt_syshost_main.o xalt_fgets_alloc.o
	gcc -O2 -o $@ $^

xalt_syshost_main.o: $(CURDIR)/xalt_syshost.c xalt_fgets_alloc.h
	gcc -c -DHAVE_MAIN -O2 -o $@ $<

$(DESTDIR)$(LIBEXEC)/xalt_generate_assembly: xalt_generate_assembly.o parseJsonStr.o epoch.o jsmn.o xalt_quotestring.o
	g++ -O2 -o $@ $^

$(DESTDIR)$(LIBEXEC)/xalt_generate_linkdata: xalt_generate_linkdata.o parseJsonStr.o Process.o xalt_fgets_alloc.o     \
                                             xalt_quotestring.o parseJsonStr.o buildRmapT.o jsmn.o xalt_mysql_utils.o \
                                             xalt_utils.o Json.o base64.o parseLDTrace.o capture.o link_direct2db.o   \
                                             zstring.o  ConfigParser.o transmit.o
	g++ -O2 -o $@ $^ $(MYSQL_LDFLAGS) -lz

$(DESTDIR)$(LIBEXEC)/xalt_strip_linklib: xalt_strip_linklib.o xalt_quotestring.o parseJsonStr.o buildRmapT.o jsmn.o xalt_utils.o xalt_fgets_alloc.o
	g++ -O2 -o $@ $^

$(DESTDIR)$(LIBEXEC)/xalt_extract_linker: xalt_extract_linker.o Process.o Json.o xalt_quotestring.o xalt_fgets_alloc.o
	g++ -O2 -o $@ $^

$(DESTDIR)$(LIBEXEC)/xalt_file_to_db: f2db.o f2db_Options.o buildRmapT.o xalt_quotestring.o jsmn.o  \
                                      parseJsonStr.o Json.o epoch.o xalt_utils.o xalt_fgets_alloc.o \
                                      link_direct2db.o run_direct2db.o ProgressBar.o translate.o    \
                                      xalt_mysql_utils.o ConfigParser.o base64.o

	g++ -O2 -o $@ $^ -lz $(MYSQL_LDFLAGS)

build_init: $(DESTDIR)$(LIBEXEC)/xalt_quotestring.o $(DESTDIR)$(LIBEXEC)/xalt_syshost.o            \
            $(DESTDIR)$(LIBEXEC)/xalt_fgets_alloc.o $(DESTDIR)$(LIBEXEC)/xalt_initialize_preload.o \
            $(DESTDIR)$(LIBEXEC)/libxalt_init.so    $(DESTDIR)$(LIBEXEC)/xalt_initialize_dbg.o     \
            $(DESTDIR)$(LIBEXEC)/xalt_initialize.o 

$(DESTDIR)$(LIBEXEC)/xalt_quotestring.o: xalt_quotestring.c xalt_quotestring.h
	gcc $(CF_INIT) -o $@ -c $<

$(DESTDIR)$(LIBEXEC)/xalt_syshost.o: $(CURDIR)/xalt_syshost.c
	gcc $(CF_INIT) -o $@ -c $< 
$(DESTDIR)$(LIBEXEC)/xalt_fgets_alloc.o: xalt_fgets_alloc.c xalt_fgets_alloc.h
	gcc $(CF_INIT) -o $@ -c $<

$(DESTDIR)$(LIBEXEC)/xalt_initialize_preload.o: xalt_initialize.c xalt_quotestring.h build_h/xalt_config.h 
	gcc $(CF_INIT) -Ibuild_h -DSTATE=LD_PRELOAD -o $@ -c $<

$(DESTDIR)$(LIBEXEC)/libxalt_init.so: $(DESTDIR)$(LIBEXEC)/xalt_initialize_preload.o $(DESTDIR)$(LIBEXEC)/xalt_syshost.o $(DESTDIR)$(LIBEXEC)/xalt_quotestring.o $(DESTDIR)$(LIBEXEC)/xalt_fgets_alloc.o
	gcc $(CF_INIT) $(LIB_OPTIONS) -o $@  $^ -luuid

$(DESTDIR)$(LIBEXEC)/xalt_initialize_dbg.o: xalt_initialize.c xalt_quotestring.h build_h/xalt_config.h 
	gcc $(CF_INIT) -Ibuild_h -g -O0 -DSTATE=LD_PRELOAD -o $@ -c $<

$(DESTDIR)$(LIBEXEC)/libxalt_init_dbg.so: $(DESTDIR)$(LIBEXEC)/xalt_initialize_dbg.o $(DESTDIR)$(LIBEXEC)/xalt_syshost.o $(DESTDIR)$(LIBEXEC)/xalt_quotestring.o $(DESTDIR)$(LIBEXEC)/xalt_fgets_alloc.o
	gcc $(CF_INIT) -g -O0 $(LIB_OPTIONS) -o $@ $^ -luuid; 

$(DESTDIR)$(LIBEXEC)/xalt_initialize.o: xalt_initialize.c xalt_quotestring.h build_h/xalt_config.h 
	gcc $(CF_INIT) -DSTATE=REGULAR -Ibuild_h  -o $@ -c $<

makefile: Makefile.in config.status
	./config.status $@


neat:
	$(RM) *~
clean: 
	$(RM) *.o 
remove_genfiles:
	$(RM) -r $(THIS_DIR)/build_h/xalt_config.h $(THIS_DIR)/build_h/xalt_regex.h $(THIS_DIR)/build_h


ConfigParser.o: ConfigParser.C ConfigParser.h build_h/xalt_config.h base64.h xalt_fgets_alloc.h xalt_utils.h xalt_types.h
Json.o: Json.C Json.h xalt_quotestring.h xalt_types.h 
Options.o: Options.C Options.h capture.h build_h/xalt_config.h xalt_types.h
Process.o: Process.C Process.h xalt_fgets_alloc.h 
ProgressBar.o: ProgressBar.C ProgressBar.h 
base64.o: base64.C base64.h
buildEnvT.o: buildEnvT.C run_submission.h Options.h xalt_types.h
buildRmapT.o: buildRmapT.C build_h/xalt_config.h buildRmapT.h Options.h xalt_types.h xalt_quotestring.h jsmn.h \
              xalt_fgets_alloc.h xalt_utils.h parseJsonStr.h
buildUserT.o: buildUserT.C run_submission.h Options.h xalt_types.h
capture.o: capture.C  capture.h xalt_types.h
epoch.o: epoch.C epoch.h
extractXALTRecord.o: extractXALTRecord.C run_submission.h Options.h xalt_types.h build_h/xalt_config.h capture.h
f2db.o: f2db.C f2db_Options.h buildRmapT.h xalt_types.h epoch.h xalt_fgets_alloc.h link_direct2db.h run_direct2db.h run_submission.h ProgressBar.h 
f2db_Options.o: f2db_Options.C f2db_Options.h
jsmn.o: jsmn.c jsmn.h
link_direct2db.o: link_direct2db.C link_direct2db.h link_submission.h xalt_types.h ConfigParser.h Json.h xalt_mysql_utils.h ConfigParser.h
parseJsonStr.o: parseJsonStr.C parseJsonStr.h jsmn.h xalt_quotestring.h
parseLDD.o: parseLDD.C run_submission.h Options.h xalt_types.h build_h/xalt_config.h capture.h
parseLDTrace.o: parseLDTrace.C link_submission.h xalt_types.h xalt_fgets_alloc.h build_h/xalt_config.h capture.h
run_direct2db.o: run_direct2db.C run_direct2db.h run_submission.h Options.h xalt_types.h ConfigParser.h build_h/xalt_regex.h Json.h xalt_mysql_utils.h xalt_utils.h ConfigParser.h
translate.o: translate.C run_submission.h Options.h xalt_types.h build_h/xalt_config.h xalt_utils.h
transmit.o: transmit.C transmit.h base64.h zstring.h xalt_types.h xalt_utils.h build_h/xalt_config.h 
xalt_extract_linker.o: xalt_extract_linker.C xalt_types.h Process.h Json.h
xalt_fgets_alloc.o: xalt_fgets_alloc.c xalt_fgets_alloc.h
xalt_generate_assembly.o: xalt_generate_assembly.C xalt_types.h jsmn.h build_h/xalt_config.h epoch.h
xalt_generate_linkdata.o: xalt_generate_linkdata.C link_direct2db.h link_submission.h Json.h parseJsonStr.h build_h/xalt_config.h xalt_types.h transmit.h capture.h buildRmapT.h  xalt_utils.h
xalt_mysql_utils.o: xalt_mysql_utils.C xalt_mysql_utils.h xalt_types.h xalt_utils.h ConfigParser.h
xalt_quotestring.o: xalt_quotestring.c xalt_quotestring.h
xalt_run_submission.o: xalt_run_submission.C run_direct2db.h run_submission.h Options.h Json.h xalt_types.h transmit.h build_h/xalt_config.h capture.h buildRmapT.h
xalt_strip_linklib.o: xalt_strip_linklib.C xalt_types.h buildRmapT.h
xalt_utils.o: xalt_utils.C xalt_utils.h xalt_types.h build_h/xalt_config.h
zstring.o: zstring.C zstring.h
